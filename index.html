<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stateless AI Test Plan Generator ‚Äì Free, Open Source, Privacy-First Frontend AI Tool</title>
    <meta name="description"
        content="Generate AI-powered test plans securely in your browser. Stateless, privacy-first, frontend-only web application‚Äîno data storage, no tracking, open source, and free forever.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.4.0/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Glassmorphism Color Palette */
            --primary: #8b5cf6;
            /* Violet 500 */
            --primary-hover: #7c3aed;
            /* Violet 600 */
            --primary-light: #ede9fe;
            /* Violet 100 */

            --bg-gradient-start: #0f172a;
            /* Slate 900 */
            --bg-gradient-end: #1e293b;
            /* Slate 800 */

            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.18);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);

            --text-main: #f8fafc;
            /* Slate 50 */
            --text-muted: #cbd5e1;
            /* Slate 300 */
            --text-dark: #0f172a;
            /* For light backgrounds */

            --border-light: rgba(255, 255, 255, 0.18);
            --border-focus: #8b5cf6;

            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
            --shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.37);

            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            background-attachment: fixed;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* Glassmorphism Card Style */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-glass);
            border-radius: var(--radius-xl);
            transition: all 0.3s ease;
        }

        .card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.45);
        }

        /* Loading Animation */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Enhanced Markdown Styling - Glassmorphism */
        #output {
            line-height: 1.75;
            color: var(--text-dark);
        }

        #output h1 {
            font-size: 1.85rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        }

        #output h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-top: 1.75rem;
            margin-bottom: 1rem;
            padding-left: 0.75rem;
            border-left: 4px solid var(--primary);
        }

        #output h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        #output p {
            margin-bottom: 1.25rem;
            color: #334155;
        }

        #output ul,
        #output ol {
            margin-bottom: 1.25rem;
            padding-left: 1.5rem;
        }

        #output li {
            margin-bottom: 0.5rem;
            color: #475569;
        }

        /* Tables in Output */
        #output .table-wrapper {
            overflow-x: auto;
            margin: 1.5rem 0;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #output table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
        }

        #output th {
            background: rgba(139, 92, 246, 0.1);
            color: #1e293b;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        #output td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            color: #475569;
            font-size: 0.9rem;
        }

        #output tr:last-child td {
            border-bottom: none;
        }

        #output tbody tr:hover {
            background-color: rgba(139, 92, 246, 0.05);
        }

        /* Code Blocks */
        #output pre {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
            padding: 1rem;
            border-radius: var(--radius-md);
            overflow-x: auto;
            margin: 1.5rem 0;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        #output code {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875em;
        }

        #output :not(pre)>code {
            background: rgba(139, 92, 246, 0.1);
            color: #7c3aed;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        #output blockquote {
            border-left: 4px solid var(--primary);
            background: rgba(139, 92, 246, 0.05);
            padding: 1rem;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            margin: 1.5rem 0;
            color: #475569;
            font-style: italic;
        }

        /* Mermaid Diagram Container */
        .mermaid {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(139, 92, 246, 0.2);
            overflow-x: auto;
            margin: 1.5rem 0;
            text-align: center;
        }

        /* Ensure SVG scales properly */
        .mermaid svg {
            max-width: 100%;
            height: auto;
            min-width: 600px;
            /* Ensure diagrams don't get squeezed too small */
        }

        /* Dark Theme - Output Section Styling */
        @media (prefers-color-scheme: dark) {
            #output {
                background: rgba(30, 41, 59, 0.3);
                border-radius: var(--radius-lg);
                padding: 1.5rem;
            }

            #output h1,
            #output h2,
            #output h3,
            #output h4,
            #output h5,
            #output h6 {
                color: #f8fafc !important;
            }

            #output p {
                color: #cbd5e1 !important;
            }

            #output ul,
            #output ol {
                color: #cbd5e1 !important;
            }

            #output li {
                color: #cbd5e1 !important;
            }

            #output strong {
                color: #f8fafc !important;
            }

            #output th {
                background: rgba(139, 92, 246, 0.2) !important;
                color: #f8fafc !important;
            }

            #output td {
                color: #cbd5e1 !important;
            }

            #output blockquote {
                color: #cbd5e1 !important;
                background: rgba(139, 92, 246, 0.1) !important;
            }

            #output :not(pre)>code {
                background: rgba(139, 92, 246, 0.2) !important;
                color: #c4b5fd !important;
            }

            #output .table-wrapper {
                background: rgba(30, 41, 59, 0.3) !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
            }
        }



        /* Safari Backdrop Support */
        .backdrop-blur-sm {
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }

        /* Range Slider Browser Consistency */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }

        /* Webkit (Chrome, Safari, Edge) - Track */
        input[type=range]::-webkit-slider-track {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Webkit - Thumb */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #8b5cf6;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -5px;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            background: #7c3aed;
        }

        /* Firefox - Track */
        input[type=range]::-moz-range-track {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
        }

        /* Firefox - Thumb */
        input[type=range]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #8b5cf6;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type=range]::-moz-range-thumb:hover {
            background: #7c3aed;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
        }

        input[type=range]:focus::-moz-range-thumb {
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
        }

        /* Experience Progress Bar */
        .experience-bar {
            width: 100%;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .experience-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
        }

        .experience-bar:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Light Theme Support */
        @media (prefers-color-scheme: light) {
            :root {
                --bg-gradient-start: #f8fafc;
                --bg-gradient-end: #e2e8f0;
                --glass-bg: rgba(255, 255, 255, 0.7);
                --glass-border: rgba(148, 163, 184, 0.3);
                --text-main: #0f172a;
                --text-muted: #475569;
                --border-light: rgba(148, 163, 184, 0.3);
            }

            body {
                background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            }

            .card {
                background: var(--glass-bg);
                border-color: var(--glass-border);
            }

            /* Light theme text colors */
            h1,
            h2,
            h3,
            label,
            p,
            span,
            button {
                color: var(--text-main) !important;
            }

            /* Light theme input styles */
            input[type="password"],
            input[type="date"],
            select {
                background: rgba(255, 255, 255, 0.9) !important;
                border-color: rgba(148, 163, 184, 0.3) !important;
                color: var(--text-main) !important;
            }

            /* Light theme option styles */
            select option {
                background: white !important;
                color: #0f172a !important;
            }

            input::placeholder {
                color: #94a3b8 !important;
            }

            /* Light theme buttons */
            #saveApiKey,
            #addTester,
            #downloadPdf {
                background: var(--primary) !important;
                color: white !important;
            }

            /* Light theme links */
            a {
                color: var(--primary) !important;
            }

            /* Light theme borders */
            .border-white\/10,
            .border-white\/20 {
                border-color: rgba(148, 163, 184, 0.2) !important;
            }

            /* Light theme backgrounds */
            .bg-white\/5,
            .bg-white\/10 {
                background-color: rgba(255, 255, 255, 0.5) !important;
            }

            /* Light theme loading overlay */
            #loadingOverlay {
                background-color: rgba(15, 23, 42, 0.5) !important;
            }

            #loadingOverlay>div {
                background: rgba(255, 255, 255, 0.95) !important;
                backdrop-filter: blur(20px) !important;
            }

            #loadingOverlay h3,
            #loadingOverlay p {
                color: var(--text-main) !important;
            }

            /* Light theme output placeholder */
            #output .text-white\/30,
            #output .text-white\/50 {
                color: #94a3b8 !important;
            }

            /* Light theme footer */
            .text-white\/50,
            .text-white\/60,
            .text-white\/70,
            .text-white\/80 {
                color: var(--text-muted) !important;
            }
        }

        /* Dark Theme - Dropdown Option Styling */
        @media (prefers-color-scheme: dark) {
            select option {
                background-color: #1e293b;
                color: #f8fafc;
            }
        }

        /* Force option colors for all themes */
        select option {
            background-color: #1e293b;
            color: #f8fafc;
            padding: 8px;
        }

        /* Light mode override for options */
        @media (prefers-color-scheme: light) {
            select option {
                background-color: white;
                color: #0f172a;
            }
        }

        /* Scrollbar hiding utilities */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }
    </style>
</head>

<body class="min-h-screen">
    <div class="container mx-auto px-4 py-12 max-w-6xl">
        <!-- Header / Hero -->
        <div class="mb-12 text-center">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-white mb-2">AI Test Plan Generator</h1>
            <p class="text-lg md:text-xl text-slate-200 mb-4 max-w-2xl mx-auto leading-relaxed">
                AI-driven test planning‚Äî100% in your browser. No storage, no tracking, fully privacy-first.
            </p>

        </div>

        <!-- Configuration Section -->
        <div class="mb-8 max-w-2xl mx-auto">
            <!-- API Key Card -->
            <div class="card p-6 md:p-8">
                <div class="flex items-center justify-between mb-4">
                    <label for="apiProvider" class="block text-sm font-semibold text-white">
                        AI Provider
                    </label>
                    <a href="#" class="text-xs text-violet-300 hover:text-violet-200 font-medium">Need a key?</a>
                </div>

                <div class="mb-5">
                    <div class="relative">
                        <select id="apiProvider"
                            class="w-full pl-4 pr-10 py-3 bg-white/10 border border-white/20 rounded-lg text-white font-medium focus:bg-white/20 focus:border-violet-400 focus:ring-4 focus:ring-violet-500/20 outline-none transition-all appearance-none cursor-pointer">
                            <option value="gemini">Google Gemini</option>
                            <option value="openai">OpenAI (GPT-4)</option>
                        </select>
                        <div
                            class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-white/60">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <label for="apiKey" class="block text-sm font-semibold text-white mb-2">
                    API Key
                </label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <div class="flex-1">
                        <input type="password" id="apiKey" placeholder="Enter your API key..."
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:border-violet-400 focus:ring-4 focus:ring-violet-500/20 outline-none transition-all" />
                        <p id="apiKeyValidation" class="text-xs mt-2 hidden font-medium"></p>
                    </div>
                    <button id="saveApiKey"
                        class="w-full sm:w-auto px-6 py-3 bg-violet-600 text-white rounded-lg hover:bg-violet-700 focus:ring-4 focus:ring-violet-500/30 transition-all font-medium whitespace-nowrap shadow-lg hover:shadow-xl active:scale-95">
                        Save
                    </button>
                </div>
                <p class="text-xs text-white/60 mt-3 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                        </path>
                    </svg>
                    Stored locally in your browser
                </p>
            </div>
        </div>

        <!-- Main Content Stack -->
        <div class="space-y-8">
            <!-- Inputs Section (Top Grid) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-stretch">
                <!-- File Upload -->
                <div class="card p-6 flex flex-col">
                    <h2 class="text-sm font-bold text-white uppercase tracking-wide mb-4">1. Requirements</h2>
                    <div
                        class="group relative border-2 border-dashed border-white/30 rounded-xl p-6 text-center hover:border-violet-400 hover:bg-white/5 transition-all cursor-pointer flex-grow flex flex-col justify-center items-center">
                        <input type="file" id="fileInput" accept=".pdf,.txt"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />

                        <div class="space-y-3 pointer-events-none">
                            <div
                                class="mx-auto w-12 h-12 bg-violet-500/20 text-violet-300 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-white">Upload Requirements</p>
                                <p class="text-xs text-white/60 mt-1">Drop PDF or TXT here</p>
                            </div>
                        </div>
                    </div>
                    <div id="fileName"
                        class="mt-3 p-3 bg-violet-500/20 text-violet-200 rounded-lg text-sm font-medium hidden flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="truncate"></span>
                    </div>
                </div>

                <!-- Timeline Input -->
                <div class="card p-6 flex flex-col">
                    <label class="block text-sm font-bold text-white uppercase tracking-wide mb-4">
                        2. Timeline
                    </label>
                    <div class="flex flex-col gap-4 flex-grow">
                        <div>
                            <label for="startDate" class="block text-xs font-medium text-white/70 mb-1">Start
                                Date</label>
                            <input type="date" id="startDate" name="startDate"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:border-violet-400 focus:ring-4 focus:ring-violet-500/20 outline-none transition-all" />
                        </div>
                        <div>
                            <label for="endDate" class="block text-xs font-medium text-white/70 mb-1">End Date</label>
                            <input type="date" id="endDate" name="endDate"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:border-violet-400 focus:ring-4 focus:ring-violet-500/20 outline-none transition-all" />
                        </div>
                    </div>
                    <!-- Timeline Stats -->
                    <div id="timelineStats" class="hidden mt-4 pt-4 border-t border-white/10 grid grid-cols-2 gap-4">
                        <div class="bg-white/5 rounded-lg p-3 text-center">
                            <p class="text-[10px] uppercase font-bold text-white/50 tracking-wider">Total Days</p>
                            <p id="totalDays" class="text-xl font-bold text-white mt-1">-</p>
                        </div>
                        <div class="bg-violet-500/10 rounded-lg p-3 text-center border border-violet-500/20">
                            <p class="text-[10px] uppercase font-bold text-violet-300 tracking-wider">Working Days</p>
                            <p id="workingDays" class="text-xl font-bold text-violet-200 mt-1">-</p>
                        </div>
                    </div>
                </div>

                <!-- Resource Manager -->
                <div class="card p-6 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-bold text-white uppercase tracking-wide">3. Team</h2>
                        <button id="addTester"
                            class="px-3 py-1.5 bg-violet-500/20 text-violet-300 hover:bg-violet-500/30 rounded-md text-xs font-bold uppercase tracking-wide transition-colors">
                            + Add
                        </button>
                    </div>
                    <div id="testersList" class="space-y-4 flex-grow">
                        <!-- Testers will be added here dynamically -->
                    </div>
                    <div id="noTesters" class="text-center py-8 border border-dashed border-white/20 rounded-lg">
                        <p class="text-sm text-white/50 font-medium">No testers added</p>
                    </div>
                </div>
            </div>

            <!-- Generate Button -->
            <button id="generateBtn"
                class="w-full py-4 bg-gradient-to-r from-violet-600 to-purple-600 text-white rounded-xl hover:shadow-2xl hover:from-violet-700 hover:to-purple-700 focus:ring-4 focus:ring-violet-500/30 transition-all font-bold text-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
                disabled>
                Generate Test Plan
            </button>

            <!-- Output Section -->
            <div class="card p-8 min-h-[600px] flex flex-col">
                <div class="flex justify-between items-center mb-6 pb-6 border-b border-white/10">
                    <h2 class="text-xl font-bold text-white">Test Plan</h2>
                    <button id="downloadPdf"
                        class="hidden flex items-center gap-2 px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors text-sm font-medium shadow-lg">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download PDF
                    </button>
                </div>
                <div id="output" class="flex-grow max-w-none fade-in">
                    <div class="h-full flex flex-col items-center justify-center text-white/30 py-20">
                        <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-4">
                            <svg class="h-10 w-10 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                                </path>
                            </svg>
                        </div>
                        <p class="font-medium text-white/50">Ready to generate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Disclaimer Section (Hidden by default, shown after generation) -->
        <div id="aiDisclaimer" class="hidden mt-12 max-w-4xl mx-auto">
            <div class="card p-6 border-l-4 border-yellow-500">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                            </path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-white mb-2">‚ö†Ô∏è AI-Generated Content Notice</h3>
                        <div class="text-white/80 text-sm leading-relaxed">
                            <p class="mb-2">This test plan was generated by AI and may contain errors, omissions, or
                                inaccuracies. <strong class="text-white">Human review and validation are
                                    required.</strong></p>
                            <ul class="list-disc pl-5 space-y-1">
                                <li>Always verify the content against your specific requirements and organizational
                                    standards.</li>
                                <li>If you are not satisfied with the response, please refine your inputs and <strong
                                        class="text-white">regenerate the plan</strong>.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer / Features -->
        <div class="mt-16 pt-8 border-t border-white/10 text-center">
            <div class="flex flex-wrap justify-center gap-4 text-sm font-medium text-white/80">
                <span
                    class="flex items-center gap-1.5 px-3 py-1.5 bg-white/10 border border-white/20 rounded-full shadow-sm backdrop-blur-sm">
                    üîê Local Execution
                </span>
                <span
                    class="flex items-center gap-1.5 px-3 py-1.5 bg-white/10 border border-white/20 rounded-full shadow-sm backdrop-blur-sm">
                    üö´ No Tracking
                </span>
                <span
                    class="flex items-center gap-1.5 px-3 py-1.5 bg-white/10 border border-white/20 rounded-full shadow-sm backdrop-blur-sm">
                    üì¶ Open Source
                </span>
                <span
                    class="flex items-center gap-1.5 px-3 py-1.5 bg-white/10 border border-white/20 rounded-full shadow-sm backdrop-blur-sm">
                    üí∏ Free Forever
                </span>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                <p class="text-xs text-white/50">
                    &copy; 2026 AI Test Plan Generator. Runs entirely in your browser.
                </p>
                <a href="https://github.com/Subrat-Pradhan/testPlanGeneration" target="_blank" rel="noopener noreferrer"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg text-white text-xs font-medium transition-all hover:scale-105">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path fill-rule="evenodd"
                            d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                            clip-rule="evenodd"></path>
                    </svg>
                    View on GitHub
                </a>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-md z-50 flex items-center justify-center transition-opacity">
        <div
            class="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl shadow-2xl p-8 max-w-sm mx-4 text-center transform scale-100 transition-transform">
            <div
                class="animate-spin rounded-full h-12 w-12 border-4 border-violet-300/30 border-t-violet-400 mx-auto mb-6">
            </div>
            <h3 class="text-lg font-bold text-white mb-2">Generating Plan</h3>
            <p class="text-white/70 text-sm">Analyzing requirements and building your test strategy...</p>
        </div>
    </div>

    <script>
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize PDF.js worker
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            } else {
                console.error('PDF.js library not loaded');
            }

            // Configure marked.js for table support (GFM mode)
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    gfm: true, // Enable GitHub Flavored Markdown (includes tables)
                    breaks: true, // Convert line breaks to <br>
                    headerIds: false,
                    mangle: false
                });
            }

            // State management
            let apiProvider = sessionStorage.getItem('ai_provider') || 'openai';
            let apiKey = sessionStorage.getItem(`${apiProvider}_api_key`) || '';
            let testers = [];
            const tokenLimit = 16000; // Fixed token limit

            // Provider configurations
            const providers = {
                openai: {
                    name: 'OpenAI',
                    keyPrefix: 'sk-',
                    placeholder: 'sk-...',
                    keyUrl: 'https://platform.openai.com/account/api-keys',
                    validate: (key) => key.startsWith('sk-')
                },
                gemini: {
                    name: 'Google Gemini',
                    keyPrefix: 'AIza',
                    placeholder: 'AIza...',
                    keyUrl: 'https://makersuite.google.com/app/apikey',
                    validate: (key) => key.startsWith('AIza')
                }
            };

            // DOM Elements
            const apiProviderSelect = document.getElementById('apiProvider');
            const apiKeyInput = document.getElementById('apiKey');
            const apiKeyValidation = document.getElementById('apiKeyValidation');
            const saveApiKeyBtn = document.getElementById('saveApiKey');
            const fileInput = document.getElementById('fileInput');
            const fileName = document.getElementById('fileName');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const addTesterBtn = document.getElementById('addTester');
            const testersList = document.getElementById('testersList');
            const noTesters = document.getElementById('noTesters');
            const generateBtn = document.getElementById('generateBtn');
            const output = document.getElementById('output');
            const downloadPdfBtn = document.getElementById('downloadPdf');
            const loadingOverlay = document.getElementById('loadingOverlay');

            // Set minimum date to today for date inputs
            const today = new Date().toISOString().split('T')[0];
            startDateInput.setAttribute('min', today);
            endDateInput.setAttribute('min', today);

            // Validate end date is after start date
            startDateInput.addEventListener('change', (e) => {
                if (endDateInput.value && e.target.value > endDateInput.value) {
                    endDateInput.value = '';
                }
                endDateInput.setAttribute('min', e.target.value || today);
            });

            endDateInput.addEventListener('change', (e) => {
                if (startDateInput.value && e.target.value < startDateInput.value) {
                    alert('End date must be after start date');
                    e.target.value = '';
                }
            });

            // Load saved provider and API key
            apiProviderSelect.value = apiProvider;
            if (apiKey) {
                apiKeyInput.value = apiKey;
            }
            updatePlaceholder();

            // Update placeholder when provider changes
            apiProviderSelect.addEventListener('change', (e) => {
                apiProvider = e.target.value;
                sessionStorage.setItem('ai_provider', apiProvider);
                // Load provider-specific key
                apiKey = sessionStorage.getItem(`${apiProvider}_api_key`) || '';
                apiKeyInput.value = apiKey;
                updatePlaceholder();
                validateApiKey(apiKey);
                checkGenerateButtonState();
            });

            function updatePlaceholder() {
                const provider = providers[apiProvider];
                apiKeyInput.placeholder = provider.placeholder;
            }

            function validateApiKey(key) {
                if (key.length === 0) {
                    apiKeyValidation.classList.add('hidden');
                    apiKeyInput.classList.remove('border-red-500', 'border-green-500', 'border-slate-200');
                    apiKeyInput.classList.add('border-slate-200');
                    return false;
                }

                const provider = providers[apiProvider];
                apiKeyValidation.classList.remove('hidden');
                apiKeyInput.classList.remove('border-slate-200', 'border-red-500', 'border-green-500');

                if (provider.validate(key)) {
                    apiKeyValidation.textContent = `‚úÖ Valid ${provider.name} API key format`;
                    apiKeyValidation.className = 'text-xs mt-2 text-green-600 font-medium';
                    apiKeyInput.classList.add('border-green-500');
                    return true;
                } else {
                    apiKeyValidation.textContent = `‚ö†Ô∏è Invalid format! ${provider.name} keys start with "${provider.keyPrefix}"`;
                    apiKeyValidation.className = 'text-xs mt-2 text-red-600 font-medium';
                    apiKeyInput.classList.add('border-red-500');
                    return false;
                }
            }

            // Real-time API key validation
            apiKeyInput.addEventListener('input', (e) => {
                validateApiKey(e.target.value.trim());
            });

            // Save API Key
            saveApiKeyBtn.addEventListener('click', () => {
                apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    alert('Please enter an API key');
                    return;
                }

                const provider = providers[apiProvider];

                // Validate API key format
                if (!provider.validate(apiKey)) {
                    alert(`‚ö†Ô∏è Invalid API key format!\n\n${provider.name} API keys should start with "${provider.keyPrefix}".\n\nYou entered a key starting with "${apiKey.substring(0, 7)}..."\n\nPlease get your ${provider.name} API key from: ${provider.keyUrl}`);
                    apiKeyInput.focus();
                    return;
                }

                sessionStorage.setItem(`${apiProvider}_api_key`, apiKey);
                sessionStorage.setItem('ai_provider', apiProvider);
                alert(`‚úÖ ${provider.name} API key saved successfully!`);
                checkGenerateButtonState();
            });

            // File Upload Handler
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Update text to show file name
                const fileNameEl = fileName.querySelector('span') || fileName;
                fileNameEl.textContent = file.name;

                // Re-add icon if it was overwritten or ensure structure
                if (!fileName.querySelector('svg')) {
                    fileName.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span class="truncate">${file.name}</span>`;
                } else {
                    fileName.querySelector('span').textContent = file.name;
                }

                fileName.classList.remove('hidden');
                checkGenerateButtonState();
            });

            // Timeline Logic
            const timelineStats = document.getElementById('timelineStats');
            const totalDaysEl = document.getElementById('totalDays');
            const workingDaysEl = document.getElementById('workingDays');

            function calculateWorkingDays(start, end) {
                let count = 0;
                let current = new Date(start);
                const endDate = new Date(end);

                while (current <= endDate) {
                    const day = current.getDay();
                    if (day !== 0 && day !== 6) { // 0 is Sunday, 6 is Saturday
                        count++;
                    }
                    current.setDate(current.getDate() + 1);
                }
                return count;
            }

            function updateTimelineStats() {
                const start = startDateInput.value;
                const end = endDateInput.value;

                if (start && end) {
                    const startDate = new Date(start);
                    const endDate = new Date(end);

                    if (endDate >= startDate) {
                        // Calculate total days (inclusive)
                        const diffTime = Math.abs(endDate - startDate);
                        const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                        // Calculate working days
                        const workingDays = calculateWorkingDays(startDate, endDate);

                        totalDaysEl.textContent = totalDays;
                        workingDaysEl.textContent = workingDays;
                        timelineStats.classList.remove('hidden');
                        timelineStats.classList.add('grid');
                    } else {
                        timelineStats.classList.add('hidden');
                        timelineStats.classList.remove('grid');
                    }
                } else {
                    timelineStats.classList.add('hidden');
                    timelineStats.classList.remove('grid');
                }
            }

            startDateInput.addEventListener('change', updateTimelineStats);
            endDateInput.addEventListener('change', updateTimelineStats);

            // Extract text from file
            async function extractTextFromFile(file) {
                // ... existing implementation ...
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();

                    reader.onload = async (e) => {
                        try {
                            if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                                // Extract text from PDF
                                const arrayBuffer = e.target.result;
                                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                                let fullText = '';

                                for (let i = 1; i <= pdf.numPages; i++) {
                                    const page = await pdf.getPage(i);
                                    const textContent = await page.getTextContent();
                                    const pageText = textContent.items.map(item => item.str).join(' ');
                                    fullText += pageText + '\n';
                                }

                                resolve(fullText);
                            } else if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                                // Extract text from TXT
                                resolve(e.target.result);
                            } else {
                                reject(new Error('Unsupported file type'));
                            }
                        } catch (error) {
                            reject(error);
                        }
                    };

                    reader.onerror = reject;

                    if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                        reader.readAsArrayBuffer(file);
                    } else {
                        reader.readAsText(file);
                    }
                });
            }

            // Add Tester
            addTesterBtn.addEventListener('click', () => {
                const testerId = Date.now();
                testers.push({
                    id: testerId,
                    experience: 0,
                    specialization: 'Manual'
                });
                renderTesters();
                checkGenerateButtonState();
            });

            // Render Testers
            function renderTesters() {
                // Conditional Scroll Logic: only scroll if > 2 testers
                if (testers.length > 2) {
                    testersList.classList.add('overflow-y-auto', 'max-h-[500px]', 'no-scrollbar', 'pr-2');
                } else {
                    testersList.classList.remove('overflow-y-auto', 'max-h-[500px]', 'no-scrollbar', 'pr-2');
                }

                if (testers.length === 0) {
                    noTesters.classList.remove('hidden');
                    testersList.innerHTML = '';
                    return;
                }

                noTesters.classList.add('hidden');
                testersList.innerHTML = testers.map(tester => `
                <div class="bg-white/5 border border-white/10 rounded-lg p-5 space-y-4 hover:border-white/20 transition-colors backdrop-blur-sm">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold text-white">${tester.specialization} Tester ${testers.indexOf(tester) + 1}</span>
                        <button 
                            onclick="removeTester(${tester.id})" 
                            class="text-red-400 hover:text-red-300 text-xs font-bold uppercase tracking-wide transition-colors"
                        >
                            Remove
                        </button>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-white/70 uppercase tracking-wide mb-2">Specialization</label>
                        <div class="relative">
                            <select 
                                onchange="updateTesterSpecialization(${tester.id}, this.value)"
                                class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-sm text-white focus:border-violet-400 focus:ring-2 focus:ring-violet-500/20 outline-none appearance-none transition-all cursor-pointer"
                            >
                                <option value="Manual" ${tester.specialization === 'Manual' ? 'selected' : ''}>Manual Testing</option>
                                <option value="Automation" ${tester.specialization === 'Automation' ? 'selected' : ''}>Automation</option>
                                <option value="Fresher" ${tester.specialization === 'Fresher' ? 'selected' : ''}>Junior / Fresher</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-white/60">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-white/70 uppercase tracking-wide mb-2">
                            Experience: <span id="exp-${tester.id}" class="text-violet-300 font-bold">${tester.experience}</span> Years
                        </label>
                        <div class="experience-bar" onclick="updateTesterExperienceFromBar(${tester.id}, event)">
                            <div class="experience-bar-fill" style="width: ${(tester.experience / 5) * 100}%">
                                ${tester.experience > 0 ? tester.experience + 'yr' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            }

            // Update Tester Experience
            window.updateTesterExperience = function (id, value) {
                const tester = testers.find(t => t.id === id);
                if (tester) {
                    tester.experience = parseInt(value);
                    document.getElementById(`exp-${id}`).textContent = value;
                }
            };

            // Update Tester Experience from Progress Bar Click
            window.updateTesterExperienceFromBar = function (id, event) {
                const bar = event.currentTarget;
                const rect = bar.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const percentage = clickX / rect.width;
                const experience = Math.round(percentage * 5);

                const tester = testers.find(t => t.id === id);
                if (tester) {
                    tester.experience = Math.max(0, Math.min(5, experience));
                    renderTesters();
                }
            };

            // Update Tester Specialization
            window.updateTesterSpecialization = function (id, value) {
                const tester = testers.find(t => t.id === id);
                if (tester) {
                    tester.specialization = value;
                    renderTesters();
                }
            };

            // Remove Tester
            window.removeTester = function (id) {
                testers = testers.filter(t => t.id !== id);
                renderTesters();
                checkGenerateButtonState();
            };

            // Check if Generate button should be enabled
            function checkGenerateButtonState() {
                const hasFile = fileInput.files.length > 0;
                const hasApiKey = apiKey.trim().length > 0;
                const hasTesters = testers.length > 0;

                generateBtn.disabled = !(hasFile && hasApiKey && hasTesters);
            }

            // Generate Test Plan
            generateBtn.addEventListener('click', async () => {
                if (!apiKey || fileInput.files.length === 0 || testers.length === 0) {
                    alert('Please fill in all required fields: API Key, Requirements Document, and at least one Tester');
                    return;
                }

                loadingOverlay.classList.remove('hidden');
                output.innerHTML = '';

                try {
                    // Extract text from file
                    const file = fileInput.files[0];
                    const requirementText = await extractTextFromFile(file);
                    const startDateValue = document.getElementById('startDate').value;
                    const endDateValue = document.getElementById('endDate').value;
                    let eta = 'Not specified';
                    if (startDateValue && endDateValue) {
                        eta = `${startDateValue} to ${endDateValue}`;
                    } else if (startDateValue) {
                        eta = `From ${startDateValue}`;
                    } else if (endDateValue) {
                        eta = `Until ${endDateValue}`;
                    }

                    // Construct prompt
                    const resourcesText = testers.map((tester, idx) =>
                        `${tester.specialization} Tester ${idx + 1}: ${tester.experience} years of experience, Specialization: ${tester.specialization}`
                    ).join('\n');

                    const prompt = `You are an experienced QA Lead. Generate a comprehensive Test Plan based on the following requirements.

REQUIREMENTS DOCUMENT:
${requirementText}

EXECUTION TIMELINE:
${eta}

TEST TEAM:
${resourcesText}

Please generate a detailed Test Plan in Markdown format that includes:

1. **Test Plan Overview** - Brief introduction and purpose

2. **Test Scope and Objectives** - What will be tested and goals

3. **Test Strategy** - Overall approach and methodology

4. **Test Environment Requirements** - Infrastructure and setup needs

5. **Test Deliverables** - List of documents and artifacts

6. **Resource Allocation** - MUST be presented as a TABLE with columns:
   - Tester Name/ID
   - Years of Experience
   - Specialization
   - Assigned Tasks/Modules (keep concise, use bullet points if needed)
   - Estimated Effort
   - Responsibilities (brief summary)

7. **Task Allocation** - MUST be presented as a TABLE with columns:
   - Task ID
   - Task Description (keep brief, 1-2 sentences max)
   - Assigned Tester
   - Priority
   - Status
   - Dependencies (brief)
   - Estimated Duration

8. **Test Schedule/Timeline** - MUST be presented as a TABLE with columns:
   - Phase/Milestone
   - Start Date
   - End Date
   - Duration
   - Responsible Tester
   - Deliverables (brief list)

9. **End to End Flow Diagram** - MUST be a Mermaid.js flowchart (graph TD/LR) depicting the complete testing flow.

10. **Risk Assessment** - MUST be presented as a TABLE with columns:
   - Risk ID
   - Risk Description (concise)
   - Probability (High/Medium/Low)
   - Impact (High/Medium/Low)
   - Mitigation Strategy (brief)
   - Owner

11. **Entry and Exit Criteria** - Clear criteria for starting and completing testing


IMPORTANT FORMATTING REQUIREMENTS:
- Use Markdown tables for ALL sections that involve structured data (Resource Allocation, Task Allocation, Schedule, Risk Assessment)
- Keep table cells CONCISE - maximum 2-3 sentences per cell. Use bullet points within cells if needed.
- Use proper Markdown table syntax with headers
- Ensure tables are well-formatted and readable with proper line breaks
- Each table row should be on a separate line in the markdown
- Add visual separators and clear section headers
- Use bullet points and numbered lists where appropriate
- Be specific about task assignments to each tester based on their experience and specialization
- STRICTLY assign tasks based on specialization (e.g. Automation Testers for scripting, Manual Testers for test case creation/execution)
- DO NOT create extremely long table cells - keep content brief and to the point

MARKDOWN TABLE FORMAT EXAMPLE (use this exact syntax - each row on a new line):
| Column 1 | Column 2 | Column 3 |
|----------|---------|----------|
| Data 1   | Data 2  | Data 3   |
| Data 4   | Data 5  | Data 6   |

CRITICAL TABLE FORMATTING RULES:
1. You MUST use the pipe (|) and dash (-) syntax shown above for ALL tables
2. Each table row MUST be on a separate line
3. Keep cell content brief - if a cell needs more detail, use bullet points or keep it to 1-2 sentences
4. Do NOT use HTML tables, ASCII art, or any other format
5. Do NOT create tables with extremely long single-line cells
6. Ensure proper line breaks between table rows

Format the output as professional, well-structured Markdown with emphasis on tables for better readability.`;

                    // Call AI API based on selected provider
                    let markdownContent;
                    const provider = providers[apiProvider];

                    if (apiProvider === 'openai') {
                        // OpenAI API call
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'gpt-4',
                                messages: [
                                    {
                                        role: 'system',
                                        content: 'You are an expert QA Lead with extensive experience in creating comprehensive test plans. Always respond in Markdown format. When creating the test plan, use Markdown tables for resource allocation and use Mermaid.js syntax for the testing workflow or timeline diagrams. CRITICAL: Use Markdown tables for Resource Allocation, Task Allocation, Test Schedule, and Risk Assessment sections. Format tables properly with clear headers and detailed information.'
                                    },
                                    {
                                        role: 'user',
                                        content: prompt
                                    }
                                ],
                                temperature: 0.7,
                                max_tokens: Math.min(tokenLimit, 16384) // OpenAI GPT-4 max is 16,384
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            let errorMessage = errorData.error?.message || 'Failed to generate test plan';

                            if (errorMessage.includes('Incorrect API key') || errorMessage.includes('Invalid API key') || errorMessage.includes('API key')) {
                                errorMessage = `üîë API Key Error\n\n${errorMessage}\n\n‚ö†Ô∏è Make sure you're using a valid ${provider.name} API key.\n\nGet your API key from: ${provider.keyUrl}`;
                            }

                            throw new Error(errorMessage);
                        }

                        const data = await response.json();
                        markdownContent = data.choices[0].message.content;

                        // Check if response was truncated
                        if (data.choices[0].finish_reason === 'length') {
                            markdownContent += '\n\n---\n\n‚ö†Ô∏è **Note:** Response was truncated due to length limits. Some content may be incomplete.';
                        }
                    } else if (apiProvider === 'gemini') {
                        // Google Gemini API call - try multiple models with fallback
                        // Using latest models (2.5 series) as 1.5 models are deprecated
                        const geminiModels = [
                            { name: 'gemini-2.5-pro-latest', version: 'v1beta' },
                            { name: 'gemini-2.5-flash', version: 'v1beta' },
                            { name: 'gemini-pro', version: 'v1' },
                            { name: 'gemini-1.5-flash', version: 'v1beta' },
                            { name: 'gemini-pro', version: 'v1beta' }
                        ];

                        let lastError = null;
                        let response = null;
                        let data = null;

                        for (const model of geminiModels) {
                            try {
                                response = await fetch(`https://generativelanguage.googleapis.com/${model.version}/models/${model.name}:generateContent?key=${apiKey}`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        contents: [{
                                            parts: [{
                                                text: `You are an expert QA Lead with extensive experience in creating comprehensive test plans. Always respond in Markdown format. When creating the test plan, use Markdown tables for resource allocation and use Mermaid.js syntax for the testing workflow or timeline diagrams. CRITICAL: Use Markdown tables for Resource Allocation, Task Allocation, Test Schedule, and Risk Assessment sections. Format tables properly with clear headers and detailed information.\n\n${prompt}`
                                            }]
                                        }],
                                        generationConfig: {
                                            temperature: 0.7,
                                            maxOutputTokens: Math.min(tokenLimit, 32000) // Gemini max is typically 32K
                                        }
                                    })
                                });

                                if (response.ok) {
                                    data = await response.json();
                                    break; // Success, exit loop
                                } else {
                                    const errorData = await response.json();
                                    lastError = errorData.error?.message || 'Failed to generate test plan';
                                    // Continue to next model if this one fails
                                }
                            } catch (err) {
                                lastError = err.message;
                                // Continue to next model
                            }
                        }

                        if (!response || !response.ok || !data) {
                            let errorMessage = lastError || 'Failed to generate test plan with any available Gemini model';

                            if (errorMessage.includes('API key') || errorMessage.includes('invalid') || errorMessage.includes('permission') || errorMessage.includes('401') || errorMessage.includes('403')) {
                                errorMessage = `üîë API Key Error\n\n${errorMessage}\n\n‚ö†Ô∏è Make sure you're using a valid ${provider.name} API key.\n\nGet your API key from: ${provider.keyUrl}`;
                            } else {
                                errorMessage = `‚ö†Ô∏è Model Error\n\n${errorMessage}\n\nüí° Tried multiple Gemini models but none worked. Please check:\n- Your API key is valid and has proper permissions\n- Check available models at: https://ai.google.dev/models/gemini\n- Ensure Gemini API is enabled in your Google Cloud Console`;
                            }

                            throw new Error(errorMessage);
                        }

                        markdownContent = data.candidates[0].content.parts[0].text;

                        // Check if response was truncated
                        if (data.candidates[0].finishReason === 'MAX_TOKENS' || data.candidates[0].finishReason === 'OTHER') {
                            markdownContent += '\n\n---\n\n‚ö†Ô∏è **Note:** Response was truncated due to token limits. Some content may be incomplete. Consider regenerating with more specific requirements.';
                        }
                    }

                    // Post-process markdown to fix table formatting issues
                    // The API sometimes returns tables as extremely long single lines
                    // Try to detect and fix this pattern

                    // Look for table patterns that span multiple pipe-separated sections
                    // If we find a very long line with many pipes, it might be a malformed table
                    const lines = markdownContent.split('\n');
                    let fixedContent = [];

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        // Check if this line looks like a table row but is extremely long
                        if (line.includes('|') && line.length > 1000) {
                            // This is likely a malformed table row
                            // Try to split it intelligently - look for patterns like "| Column |" repeated
                            // For now, just add a note and keep it
                            console.warn('Found extremely long table row at line', i, 'length:', line.length);
                            fixedContent.push(line);
                        } else {
                            fixedContent.push(line);
                        }
                    }

                    markdownContent = fixedContent.join('\n');

                    // Render markdown with table & Mermaid diagram support
                    let htmlContent;
                    try {
                        htmlContent = marked.parse(markdownContent, { gfm: true });
                        // Wrap all tables in a scrollable container
                        htmlContent = htmlContent.replace(/<table([^>]*)>([\s\S]*?)<\/table>/gi, (match, attrs, content) => {
                            return `<div class="table-wrapper"><table${attrs}>${content}</table></div>`;
                        });
                        output.innerHTML = htmlContent;
                        // --- Mermaid.js rendering logic ---
                        let mermaidBlocks = output.querySelectorAll('pre code.language-mermaid, pre.mermaid');
                        mermaidBlocks.forEach(block => {
                            const code = block.textContent;
                            const container = document.createElement('div');
                            container.className = 'mermaid';
                            container.textContent = code;
                            block.parentNode.replaceWith(container);
                        });
                        // Render Mermaid diagrams
                        if (window.mermaid) { window.mermaid.run?.(); }
                        downloadPdfBtn.classList.remove('hidden');
                        // Show AI disclaimer
                        document.getElementById('aiDisclaimer').classList.remove('hidden');
                    } catch (parseError) {
                        console.error('Markdown parsing error:', parseError);
                        // Fallback: display raw markdown with code formatting
                        output.innerHTML = `<pre class="bg-slate-100 p-4 rounded-lg overflow-auto">${markdownContent}</pre>`;
                        downloadPdfBtn.classList.remove('hidden');
                        // Show AI disclaimer
                        document.getElementById('aiDisclaimer').classList.remove('hidden');
                    }

                } catch (error) {
                    const errorText = error.message.replace(/\n/g, '<br>');
                    const provider = providers[apiProvider];
                    output.innerHTML = `
                        <div class="bg-red-50 border border-red-100 rounded-xl p-6 shadow-sm">
                            <h3 class="text-red-900 font-bold mb-3 text-lg flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                Generation Failed
                            </h3>
                            <p class="text-red-700 whitespace-pre-line text-sm leading-relaxed">${errorText}</p>
                            <div class="mt-4 p-4 bg-white/50 rounded-lg border border-red-100">
                                <p class="text-xs font-bold text-red-800 uppercase tracking-wide mb-2">Troubleshooting</p>
                                <ul class="text-sm text-red-700 space-y-1 list-disc list-inside">
                                    <li>Go to <a href="${provider.keyUrl}" target="_blank" class="underline font-medium hover:text-red-900">${provider.name} API Keys</a></li>
                                    <li>Check if your API key is valid and has credits</li>
                                    <li>Ensure you selected the correct AI Provider above</li>
                                </ul>
                            </div>
                        </div>
                    `;
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            });


            // --- PDF Printing Logic ---

            // Extract CSS rules from all stylesheets
            const extractCSSRules = () => {
                let cssText = "";
                // Get all style sheets
                for (let i = 0; i < document.styleSheets.length; i++) {
                    const sheet = document.styleSheets[i];
                    try {
                        const rules = sheet.cssRules || sheet.rules;
                        if (rules) {
                            for (let j = 0; j < rules.length; j++) {
                                cssText += rules[j].cssText + "\n";
                            }
                        }
                    } catch (e) {
                        // CORS issue with external stylesheets - try to import them
                        if (sheet.href) {
                            cssText += `@import url("${sheet.href}");\n`;
                        }
                    }
                }
                return cssText;
            };

            // Download PDF Button Handler - Using iframe print approach
            downloadPdfBtn.addEventListener('click', async () => {
                const element = output; // The content we want to print
                const originalTitle = document.title;
                const filename = "AI_Test_Plan_" + new Date().toISOString().slice(0, 10) + ".pdf";

                // Set document title for PDF
                document.title = filename.replace('.pdf', '');

                // Get team info for cover page
                const projectTeam = testers.length > 0
                    ? testers.map((t, i) => `${t.specialization} Tester ${i + 1} (${t.experience}y)`).join(', ')
                    : "Not specified";

                // Create a hidden iframe for printing
                const printFrame = document.createElement("iframe");
                printFrame.style.position = "fixed";
                printFrame.style.right = "0";
                printFrame.style.bottom = "0";
                printFrame.style.width = "0";
                printFrame.style.height = "0";
                printFrame.style.border = "0";
                printFrame.id = "printFrame";
                document.body.appendChild(printFrame);

                // Function to extract CSS rules from stylesheets
                const extractCSSRules = () => {
                    let cssText = "";
                    for (let i = 0; i < document.styleSheets.length; i++) {
                        const sheet = document.styleSheets[i];
                        try {
                            const rules = sheet.cssRules || sheet.rules;
                            if (rules) {
                                for (let j = 0; j < rules.length; j++) {
                                    cssText += rules[j].cssText + "\n";
                                }
                            }
                        } catch (e) {
                            // CORS issue with external stylesheets
                            if (sheet.href) {
                                cssText += `@import url("${sheet.href}");\n`;
                            }
                        }
                    }
                    return cssText;
                };

                // Get clean content clone
                const contentClone = element.cloneNode(true);
                const cleanContent = contentClone.innerHTML;

                // Get CSS styles
                const cssRules = extractCSSRules();

                // Write content to the iframe
                const frameDoc = printFrame.contentDocument || printFrame.contentWindow.document;
                frameDoc.open();
                frameDoc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${filename.replace('.pdf', '')}</title>
                        <link rel="preconnect" href="https://fonts.googleapis.com">
                        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                        <style>
                            /* Inlined CSS rules */
                            ${cssRules}

                            /* Print-specific styles */
                            @media print {
                                body {
                                    -webkit-print-color-adjust: exact !important;
                                    print-color-adjust: exact !important;
                                    margin: 0;
                                    padding: 0;
                                }

                                * {
                                    -webkit-print-color-adjust: exact !important;
                                    print-color-adjust: exact !important;
                                }

                                @page {
                                    size: A4;
                                    margin: 15mm;
                                }

                                .page-break {
                                    page-break-after: always;
                                }

                                /* Avoid breaks inside elements */
                                h1, h2, h3, h4, h5, h6 {
                                    page-break-after: avoid;
                                    page-break-inside: avoid;
                                }

                                table, figure, img {
                                    page-break-inside: avoid;
                                }

                                ul, ol {
                                    page-break-inside: avoid;
                                }
                            }

                            /* General body styles */
                            body {
                                font-family: 'Inter', sans-serif;
                                margin: 0;
                                padding: 0;
                                background: white;
                                color: #1e293b;
                                font-size: 11pt;
                                line-height: 1.6;
                            }

                            /* Cover page styles */
                            .cover-page {
                                height: 100vh;
                                display: flex;
                                flex-direction: column;
                                justify-content: flex-start;
                                align-items: center;
                                text-align: center;
                                padding: 60px 40px;
                                box-sizing: border-box;
                                page-break-after: always;
                            }

                            .cover-content {
                                margin-top: 80px;
                            }

                            .cover-title {
                                font-size: 2.5rem;
                                color: #4f46e5;
                                margin-bottom: 1rem;
                                font-weight: 700;
                            }

                            .cover-subtitle {
                                font-size: 1.2rem;
                                color: #64748b;
                                margin-bottom: 3rem;
                                font-weight: 400;
                            }

                            .cover-info {
                                text-align: left;
                                max-width: 500px;
                                margin: 0 auto;
                                padding: 2rem;
                                border: 2px solid #e2e8f0;
                                border-radius: 12px;
                                background: #f8fafc;
                            }

                            .cover-info p {
                                margin: 12px 0;
                                font-size: 0.95rem;
                                color: #334155;
                            }

                            .cover-info strong {
                                color: #1e293b;
                            }

                            /* Main content styles */
                            .main-content {
                                padding: 20px;
                                max-width: 100%;
                                box-sizing: border-box;
                            }

                            .main-content * {
                                word-wrap: break-word;
                                overflow-wrap: break-word;
                            }

                            .main-content h1 {
                                font-size: 1.8rem;
                                font-weight: 700;
                                color: #1e293b;
                                margin-top: 24px;
                                margin-bottom: 12px;
                                border-bottom: 2px solid #4f46e5;
                                padding-bottom: 8px;
                            }

                            .main-content h2 {
                                font-size: 1.4rem;
                                font-weight: 600;
                                color: #1e293b;
                                margin-top: 20px;
                                margin-bottom: 10px;
                                border-bottom: 1px solid #e2e8f0;
                                padding-bottom: 6px;
                            }

                            .main-content h3 {
                                font-size: 1.1rem;
                                font-weight: 600;
                                color: #1e293b;
                                margin-top: 16px;
                                margin-bottom: 8px;
                            }

                            .main-content p {
                                color: #334155;
                                margin-bottom: 10px;
                                line-height: 1.6;
                            }

                            .main-content ul,
                            .main-content ol {
                                margin-bottom: 12px;
                                padding-left: 20px;
                            }

                            .main-content li {
                                color: #334155;
                                margin-bottom: 6px;
                            }

                            .main-content table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 15px 0;
                                font-size: 9pt;
                                table-layout: fixed;
                            }

                            .main-content th,
                            .main-content td {
                                border: 1px solid #cbd5e1;
                                padding: 8px 6px;
                                color: #334155;
                                word-wrap: break-word;
                                overflow-wrap: break-word;
                                hyphens: auto;
                                font-size: 9pt;
                                line-height: 1.4;
                            }

                            .main-content th {
                                background: #f1f5f9;
                                font-weight: 600;
                                color: #1e293b;
                            }

                            .main-content pre,
                            .main-content code {
                                background: #f8fafc;
                                color: #1e293b;
                                padding: 8px;
                                border-radius: 4px;
                                font-size: 9pt;
                                white-space: pre-wrap;
                                word-wrap: break-word;
                            }

                            .main-content .mermaid {
                                page-break-inside: avoid;
                                margin: 15px 0;
                            }

                            /* Hide elements that shouldn't be printed */
                            button, .no-print {
                                display: none !important;
                            }
                        </style>
                    </head>
                    <body>
                        <!-- Cover Page -->
                        <div class="cover-page">
                            <div class="cover-content">
                                <h1 class="cover-title">Test Plan</h1>
                                <div class="cover-subtitle">Generated by AI Test Plan Generator</div>
                                <div class="cover-info">
                                    <p><strong>üìÖ Date:</strong> ${new Date().toLocaleDateString()}</p>
                                    <p><strong>ü§ñ AI Model:</strong> ${apiProvider.toUpperCase()}</p>
                                    <p><strong>üë• Team Composition:</strong> ${projectTeam}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content -->
                        <div class="main-content">
                            ${cleanContent}
                        </div>
                    </body>
                    </html>
                `);
                frameDoc.close();

                // Wait for content to load before printing
                printFrame.onload = () => {
                    try {
                        setTimeout(() => {
                            // Trigger print dialog
                            printFrame.contentWindow.focus();
                            printFrame.contentWindow.print();

                            // Clean up after printing
                            setTimeout(() => {
                                if (document.body.contains(printFrame)) {
                                    document.body.removeChild(printFrame);
                                }
                                document.title = originalTitle;
                            }, 500);
                        }, 1000); // Delay to ensure styles are applied
                    } catch (err) {
                        console.error("Print failed:", err);
                        if (document.body.contains(printFrame)) {
                            document.body.removeChild(printFrame);
                        }
                        document.title = originalTitle;
                        alert('Failed to generate PDF. Please try again.');
                    }
                };
            });

            // Initial state check
            if (apiKey) {
                validateApiKey(apiKey);
            }
            checkGenerateButtonState();
            renderTesters();
        });
    </script>
</body>

</html>